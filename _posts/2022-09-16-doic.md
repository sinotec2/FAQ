---
title: 逐3小時啟動CMAQ之嘗試
tags: python CMAQ 
layout: article
aside:
  toc: true
sidebar:
  nav: layouts
date:  2022-09-16
modify_date: 2022-09-16 16:22:33
---
## 背景

## 前處理
### CAMS檔案轉寫成ICON檔

```bash
kuang@node03 /nas1/ecmwf/CAMS/CAMS_global_atmospheric_composition_forecasts/2022
$ diff grb2iconV50.py grb2icon.py
44,45c44,46
< fcst_hr=float(np.array(nc['forecast_time0'])[0])
< bdate=datetime.datetime.strptime(nc.variables[V[3][0]].initial_time,'%m/%d/%Y (%H:%M)')+datetime.timedelta(hours=fcst_hr)
---
> #date=datetime.datetime.strptime(nc.variables[V[3][0]].initial_time,'%m/%d/%Y (%H:%M)')+datetime.timedelta(hours=12)
> td=datetime.datetime.today()
> bdate=datetime.datetime(td.year,td.month,td.day)
77,79c78,79
< path='/nas1/ecmwf/CAMS/CAMS_global_atmospheric_composition_forecasts/2022/'
< fname=path+'templateCWBWRF_45k.ncV50K24'
< fnameO='/nas2/cmaqruns/2022fcst/grid45/icon/ICON_'+bdate.strftime('%Y%m%d%H')+'_CWBWRF_45k'
---
> fname='/nas1/cmaqruns/2022fcst/data/icon/ICON_template_CWBWRF_45k'
> fnameO=fname.replace('template','yesterday')
```

### 執行迴圈腳本

```bash
#kuang@node03 /nas1/ecmwf/CAMS/CAMS_global_atmospheric_composition_forecasts/2022
#$ cat grb2iconV50.cs
src=/nas1/ecmwf/CAMS/CAMS_global_atmospheric_composition_forecasts/2022
ncks=/usr/bin/ncks
cd $src
for t in {0..40};do
for i in 1 2 3;do
  $ncks -O -d forecast_time0,$t allEA_$i.nc allEA_$i.nc_0
done
if [[ -e AllEA.nc ]];then rm AllEA.nc;fi
./merge.cs
./grb2iconV50.py >& /dev/null &
sleep 10
done
```
## CMAQ執行腳本
### profile.config模版差異

```bash
kuang@DEVP /nas2/cmaqruns/2022fcst
$ diff project.config_loop project.config_loopic
5,6c5,8
<  set startdate = YYYYJJJ      # YYYYDDD
<  set runlen    = 1210000      # HHH0000
---
>  set    hh = HH
>  setenv sdate YYYYMMDD
>  setenv startdate ${sdate}${hh} # YYYYMMDDHH
>  setenv runlen    10000               # HHH0000
13c15
<  set cmaqbcdate = ${startdate}
---
>  set cmaqbcdate = today
19c21
<  set START_DATE   = "mcip_start"
---
>  set START_DATE   = "BEGD"
```
### 逐3小時執行迴圈

```bash
kuang@DEVP /nas2/cmaqruns/2022fcst
$ cat doic.cs
today=$(date -d -0day +%Y%m%d)
BEGD=$(date -d "$today -0days" +%Y-%m-%d)
mcip_start=$BEGD
mcip_end=$(date -d ${BEGD}+4days +%Y-%m-%d)
dir1=/nas2/cmaqruns/2022fcst/grid45/cctm.ic/daily
dir2=/nas2/cmaqruns/2022fcst/grid45/cctm.ic/daily2
mkdir -p $dir2
for id in {0..4};do
  for HH in {00..21..3};do
    BEGD=$(date -d "$today +${id}days" +%Y-%m-%d)
    YYYYJJJ=$(date -d ${BEGD} +%Y%j)
    YYYYMMDD=$(date -d ${BEGD} +%Y%m%d)
    if ! [ -e /nas2/cmaqruns/2022fcst/grid45/icon/ICON_${YYYYMMDD}${HH}_CWBWRF_45k ];then continue;fi
    cp project.config_loopic project.configIC
    for cmd in 's/YYYYJJJ/'$YYYYJJJ'/g' \
           's/YYYYMMDD/'$YYYYMMDD'/g' \
           's/HH/'$HH'/g' \
           's/BEGD/'$BEGD'/g' \
           's/mcip_start/'$mcip_start'/g' \
           's/mcip_end/'$mcip_end'/g';do
      sed -ie $cmd project.configIC
    done
    csh ic.csh
    for sp in CONC PMDIAG;do
      aconc=$dir1/CCTM_A${sp}_v532_intel_CWBWRF_45k_${YYYYMMDD}${HH}.nc
      if [ -e $aconc ];then mv $aconc $dir2;fi
    done
  done
done
```

### run.cctm.45.csh腳本差異

```bash
kuang@DEVP /nas2/cmaqruns/2022fcst
$ diff ic.csh run.cctm.45.csh
7,8c7,8
< set sfile       = ./project.configIC
< set sourcefile  = ./cctm.source.v5.3.1.ae7_IC
---
> set sfile       = ./project.config
> set sourcefile  = ./cctm.source.v5.3.1.ae7
30c30
<  set myjob   = ic                   # which cases
---
>  set myjob   = fcst                   # which cases
```

### cctm.source.v5.3.1.ae7 差異

```bash
kuang@DEVP /nas2/cmaqruns/2022fcst
$ diff cctm.source.v5.3.1.ae7 cctm.source.v5.3.1.ae7_IC
60,61c60,62
<  set STTIME     = 000000           #> beginning GMT time (HHMMSS)
<  set NSTEPS     = 240000           #> time duration (HHMMSS) for this run
---
>  set HH         = `echo $startdate|cut -c9-`
>  set STTIME     = ${HH}0000        #> beginning GMT time (HHMMSS)
>  set NSTEPS     = ${runlen}        #> time duration (HHMMSS) for this run
218d218
<
253c253
<   setenv CTM_APPL ${RUNID}_${YYYYMMDD}
---
>   setenv CTM_APPL ${RUNID}_${YYYYMMDD}${HH}
264,265c264,265
<   set icname = ICON_yesterday_${GRID_NAME}
<   set bcname = BCON_today_${GRID_NAME}
---
>   set icname = ICON_${cmaqicdate}_${GRID_NAME}
>   set bcname = BCON_${cmaqbcdate}_${GRID_NAME}
621c621
<   setenv NEW_START false
---
> #  setenv NEW_START false
```

## 後處理
### 逐3小時結果串成逐日檔

```python
kuang@dev2 /nas2/cmaqruns/2022fcst/grid45/cctm.ic/daily
$ cat join_icon.py

import numpy as np
import netCDF4
import sys, os, subprocess
import datetime
from dtconvertor import dt2jul, jul2dt

bdate=datetime.datetime.strptime(sys.argv[1],"%Y-%m-%d")
YMDs=[bdate+datetime.timedelta(days=i) for i in range(5)]
path='/nas2/cmaqruns/2022fcst/grid45/cctm.ic/daily/'
tmps={i:path+'CCTM_A'+i+'_temp.nc' for i in ['PMDIAG','CONC']}
for sp in list(tmps)[1:]:
  fcst=path+'../daily2/CCTM_A'+sp+'_v532_intel_CWBWRF_45k_YYYYMMDDHH.nc'
  for day in range(1,5):
    YMDsd=YMDs[day].strftime('%Y%m%d')
    fnameO=path+'CCTM_A'+sp+'_v532_intel_CWBWRF_45k_'+YMDsd+'.nc'
#   os.system('cp '+tmps[sp]+' '+fnameO)
    nc1 = netCDF4.Dataset(fnameO, 'r+')
    V=[list(filter(lambda x:nc1.variables[x].ndim==j, [i for i in nc1.variables])) for j in [1,2,3,4]]
    nt,nlay,nrow,ncol=(nc1.variables[V[3][0]].shape[i] for i in range(4))
    nv=len(V[3])
    if day==1:var=np.zeros(shape=(nv,nt+1,nlay,nrow,ncol))
    for h in range(0,25,3):
      sdate=YMDs[day]+datetime.timedelta(hours=h)
      YMDsd,HH=sdate.strftime('%Y%m%d'),sdate.strftime('%H')
      fname=fcst.replace('YYYYMMDD',YMDsd).replace('HH',HH)
      if not os.path.isfile(fname):continue
      nc = netCDF4.Dataset(fname, 'r')
      for v in range(nv):
        var[v,h,:,:,:]=nc.variables[V[3][v]][0,:,:,:]
      if h==0:
        nc1.SDATE=nc.SDATE
        nc1.variables['TFLAG'][:,:,0]=nc.SDATE
      nc.close()
    for t in range(0,24,3):
      var[:,t+1,:,:,:]=2./3.*var[:,t,:,:,:]+1./3.*var[:,t+3,:,:,:]
      var[:,t+2,:,:,:]=1./3.*var[:,t,:,:,:]+2./3.*var[:,t+3,:,:,:]
    for v in range(nv):
      nc1.variables[V[3][v]][:,:,:,:]=var[v,:nt,:,:,:]
    nc1.close()
```
- 因為ACONC逐日檔非常大(14G)，必須先在程式外複製(5個檔約需10分鐘)。
- 本程式記憶體需求龐大，需以超微工作站執行，DEC會卡住。

### combine差異

```bash
kuang@DEVP /nas2/cmaqruns/2022fcst
$ diff combine.sh combine.shIC
5c5
< ymd=$(echo $nc|cut -d'_' -f7|cut -d'.' -f1)
---
> ymd=$(echo $nc|cut -d'_' -f2|cut -d'.' -f1)
11c11
< export cctmout=${BASE}/grid$ii/cctm.fcst/daily
---
> export cctmout=${BASE}/grid$ii/cctm.ic/daily
```

## 結果討論

| ![091800PM1_integrate.PNG](https://raw.githubusercontent.com/sinotec2/Focus-on-Air-Quality/main/assets/images/091800PM1_integrate.PNG)|
|:-:|
| <b>東亞範圍CMAQ PM<sub>1</sub>之模擬結果(積分48小時)</b>|

| ![091800PM1_initial.PNG](https://raw.githubusercontent.com/sinotec2/Focus-on-Air-Quality/main/assets/images/091800PM1_initial.PNG)|
|:-:|
| <b>東亞範圍CAMS PM<sub>1</sub>之模擬結果(CMAQ初始化1小時)</b>|
