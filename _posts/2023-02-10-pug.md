---
layout: article
title: pug模板語法
parent: Recommend System
grand_parent: website
nav_order: 99
date: 2023-02-10
last_modified_date: 2023-02-10 22:43:57
tags: forecast
aside:
  toc: true
sidebar:
  nav: layouts
---

## 背景

> 如果妳在尋找更靈活的網頁寫法，例如將網頁看成是個樣板，以使用者行為產生的變數，來置換樣板的內容，那這個簡單的pug顯然會對妳有所幫助。

- pug是express套件常用的顯示引擎之一。所謂的引擎事實上就是個編譯器，將樣板內容、套用當時前後端整體的變數環境，編譯成最後使用者看到的html檔案(如[wiki: Web_template_system][2]圖示)。

![](https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/TempEngWeb016.svg/1200px-TempEngWeb016.svg.png)

- 其他選項還包括了EJS、 handlebar、nunjucks等等引擎，因pug有自己的語法因此被認為是比較困難一點，但也正因如此而有較簡潔、直覺的強項，比較符合高階工程師的期待。
- 目前pug更新到3.0.2版(2021/03)。
- pug應用狀況
  1. 遠端運轉著大量資訊的伺服器，其複雜度不是一般網頁可以消化，需要切換數個(>10[^1])版本的網頁，才能有正確的呈現。
  2. 網頁常常需要維護、更新
  3. 前端使用者的行為不會太複雜
  4. 工程師可以接受以固定空格(tab)來定義從屬關係，即python縮排語法
- pug的中文簡要說明可以參考[前端筆記](https://orandigo.github.io/blog/2020/12/27/20201227-pug-note/)，完整的說明可以詳見官網[pug.org](https://pugjs.org/api/getting-started.html)。英文的互動說明可以參考[LHViet88@2018 Bibooki](https://pughtml.com/what-is-pug-html)
- 典型的index.pug檔案

```python
- var user = {description: 'foo bar baz'}
- var authorised = false
#user
  if user.description
    h2.green Description
    p.description= user.description
  else if authorised
    h2.blue Description
    p.description.
      User has no description,
      why not add one...
  else
    h2.red Description
    p.description User has no description
```

其效果為

```html
<div id="user">
  <h2 class="green">Description</h2>
  <p class="description">foo bar baz</p>
</div>
```

## pug中的變數

- 因為pug是在整體js環境中，除了自己本身宣告的變數之外，也可以取用或改變公用的變數(不必另外宣告)，如以下views/index.pug的片段。

### index.pub片段

```python
    div(id="menu-container" class="fluid hide_mobile")
      ul(id="menu")
        li: form(action="/" method="POST")
          - var root = "/";
          - var tauH = `tau=${reqT}`;
          - var fcsD = `fcst=${reqF}`;
          - var regR = `region=${reqR}`;
          - var fieD = `field=${reqD}`;
          - var specs = ["O3", "NO2", "CO", "SO2", "PM2.5"];
          - urlH = `${root}?${tauH}&${regR}&${fcsD}&field=`;
          div(class="category-wrapper")
            p() FIELDS
          div(class="category-wrapper")
            p() Surface
            ul
              each spName in specs
                - url = `${urlH}${spName}`
                li: a(href=url) #{spName}
```

1. 在pug語法中，縮排是有意義的，相同縮排的物件彼此是平形的，差2格縮排表示有上下從屬關係。
2. 在pug中可以接受**部分**js指令，以減號當成前綴。如範例中宣告了字串(注意合併的方式)、序列等
3. 減號前綴後如果要引用變數(包括pug內臨時宣告、或是經res.render、locals公開到程式間可以使用的公用變數)，需加上`${...}`意即環境變數。
4. 在pug語法括號`(...)`內如要引用變數，直接寫變數名稱即可，而在括號外部，則需要加上`#{...}`，如`li: a(href=url) #{spName}`

- pug變數如何傳回變數?
  - 基本上是透過html上使用者的行為。
  - 當使用者點選物件、觸發了post方法，在伺服器action的內容，讓伺服器可以藉此解讀傳回變數的內容。具體而言即為express.Router().get所傳回的reqire.query內容。
- 如以下html內容，使用者如果點擊後續物件，將會在browser命令列上出現以/為首的url文字串。

### html form段落

```html
<form action="/" method="POST">
<form action="/" method="POST" name="control_form" class="animate">
```

- 使用者觸發事件將會回傳一個網址，如在layout.pug中指定之`url=http://125.229.149.182:3000/?tau=undefined&fcst=undefined&field=O3&region=se_china`
- 此字串經routers/index.js將其中的內容記錄成為變數的值，再利用res.render()將其宣告成公用變數，如下：

### 網頁主控js

- routes/index.js

```js
var express = require('express');
var router = express.Router();

/* GET home page. */
router.get('/', function(req, res, next) {
  res.render('index', { title: 'Composition Forecast Maps ' + req.query.region + req.query.field,
    reqD: req.query.field,
    reqR: req.query.region,
    reqF: req.query.fcst,
    reqT: req.query.tou,
    reqC: req.query.control_form}
  );
});
module.exports = router;
```

### pug程式使用變數

- 範例程式將title、require所查詢到的變數內容等等對照表，再次提交（render）到respond中，讓pug程式可以使用。如views/layouts.pug

```python
doctype html
html
  head
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1")
    link(rel="shortcut icon" href="https://www.sinotech-eng.com/assets/front/images/favicon/favicon.svg" type="image/svg")
    title= title
...
```

- 範例中冒號右邊的title,內容即為router/index.js所提交的title。

## pug語法中的條件判斷

- pug的if能夠允許的形式並不多，且官網也未提及完全相等(`==`)的比較operator
- 經嘗試錯誤，發現可以這樣使用

### 全等範例

```python
div(class="category-wrapper")
  p() REGIONS
  select(name="region" onchange="window.location.href=this.value")
    - var fieD = `field=${reqD}`;
    - var regns = ["eastern_asia", "se_china", "taiwan"];
    - urlH = `${root}?${tauH}&${fcsD}&${fieD}&region=`;
    each rgName in regns
      - url = `${urlH}${rgName}`
      if reqR == rgName 
        option(value=url, selected="selected") #{rgName}
      else
        option(value=url) #{rgName}
```

- 這個範例是讓下拉選單能夠有正確的預設值，就是使用者剛剛做出的選擇，可以停留在選單上。
- 因為`if ... else`算是pug的語法範圍，類似前述`(...)`內範圍，因此可以不必加上前綴`${...}`或`#{...}`。
- 其他地方，還是按照前述規則。

### 未定義範例

```python
if ! reqR
  - var reqR = "eastern_asia";
if ! reqD
  - var reqD =  "PM2.5";
```

- 這個範例判斷使用者是否給定完整的（reqR，reqD）內容，如果是，則引用正確的檔案(設定為gif檔)，如果否，則給定內定檔。
- 因為沒有and指令，還蠻困擾的。只能用負面表列，先暫時宣告並給定一組內定值。

[^1]: 林罡北(2018)如果你是常切版的前端工程師-你一定要知道pug, [Medium][1]

[1]: https://northbei.medium.com/如果你是常切版的前端工程師-你一定要知道pug-8b2cbc0a784c "如果你是常切版的前端工程師-你一定要知道pug-8b2cbc0a784c"
[2]: https://en.wikipedia.org/wiki/Web_template_system "Web_template_system"
