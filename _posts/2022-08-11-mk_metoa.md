---
title: 將CWB數據填入WRF客觀分析場
tags: CWB WRF
layout: article
aside:
  toc: true
sidebar:
  nav: layouts
date:  2022-08-11
modify_date: 2022-08-18 15:21:10
mermaid: true
---
## 背景
- 在預備WRF的初始與邊界場時，REAL會讀取OBSGRID的客觀分析結果(metoa_em)，一般是以點狀觀測值，內插到3度空間的格點位置。
- 由於中央氣象局已經完成WRF模擬，不需要重新進行積分，反而有需要取得WRF執行結果中雲、邊界層數據，因此，需要將CWBWRF結果轉換成metoa_em檔案，以將其結果納入WRF模式中進行FDDA。
- 客觀分析結果檔(metoa_em)的內容
  - 基本上的格式、變數定義等，與metgrid結果檔(met_em)完全一樣，只差後者可能沒有海溫(SST)。
  - 垂直軸名稱為*num_metgrid_levels*，涉及6項變數：`['PRES', 'GHT', 'RH', 'VV', 'UU', 'TT']`
    - 壓力：除了地面之外，其餘33層皆為定壓層。範圍由1000mb~1mb。
    - RH相對濕度，單位為%
    - UU,VV為風速，單位為m/s
    - TT為氣溫(非位溫)，單位為K。
  - 其他項目、或這些項目100mb以上高空，與met_em相同即可
### CWBWRF與metoa_em壓力層之比較

項目|CWBWRF|metoa_em|說明
:-:|:-:|:-:|-
層數|11|34|
第1層|1000mb|地面|風速可以使用uv10、溫度可以使用T2、相對濕度不另計算，令為1000mb值
最高層|100mb|1mb|CWBWRF僅到34層中的22層
相容性|-|-|CWBWRF每層都在metoa_em中

### 內插方法
- 水平網格
  - 讓metoa_em與CWBWRF(儘可能)完全一樣。不進行內插
- 垂直內插
  - 地面無法內插。另外處理
  - CWBWRF定壓層：不必計算，直接引用
  - 其他壓力層：使用wrf-python的內插函數 [wrf.interplevel][interplevel]，不另外設計內插法。
- 時間內插
  - 雖然CWBWRF為6小時輸出、預報84小時，但在[ROOT/Data/cwb/WRF_3Km/get_M-A0064.cs](https://sinotec2.github.io/Focus-on-Air-Quality/wind_models/cwbWRF_3Km/fil_grb_nc/#自動轉檔排程)中已使用Cubic Spline將其內插到逐時，並且轉成wrfout的格式。
  - 為提供FDDA對模擬的影響，此處使用3小時為頻率、預報長度在GFS之180小時之內，採168小時(7天)。

## [mk_metoa.py][mk_metoa]程式說明

### 高度之對應
- `p`：使用wrf-python的getvar函數讀取CWBWRF的壓力(定壓層)
- `p_met`：metoa_em的模版就是met_em檔案，也讀取其中34層壓力。除地面外，其餘也是定壓層，在metgrid.exe中所定義。
- 找到`p`在`p_met`的序號、並做成`kdic`備用

```python
fname='CWB_wrfout_d01'
wrfin = Dataset(fname,'r')
p = getvar(wrfin, "pressure") #p is constant and 
...
fname='met_em.d01.'+fn_dt[0]+'.nc'
metin = Dataset(fname,'r')
p_met=getvar(metin, "pressure")
k_met=[list(p_met[:,0,0].values).index(k) for k in p[:,0,0].values]
kdic={k_met[k]:k for k in range(11)}
```

### 時間之對應
- met_em及metoa_em都是單一筆時間在一個檔案內，其時間標籤被metgrid.exe設計為檔名的一部分。只需知道起迄時間(`staend`)，所有檔名都可以datetime計算而得(`fn_dt`)。
  - 如果此時間在CWBWRF檔案中找得到，則讀取wrfout將其值內插到metoa_em檔中
  - 如否：met_em也可以做為FDDA的依據，只是是GFS 1度內插的結果，解析度較差。
- 起迄時間是namelist.input的內容，以python讀取出來成為一個dict(`staend`)
- 以時間差計算nt，要記得前後都算所以必須+1。
- `fn_dt`：以wrf系統特有的時間標籤。每3小時輸出備用。

```python
#get the start and end time of simulation
with open('namelist.input','r') as f:
  lines=[i for i in f]
inputs={}
for i in lines[1:]:
  itm=i.split()
  if len(itm)<3:continue
  try:
    inputs.update({itm[0]:float(itm[2].replace(',',''))})
  except:
    continue
staend={}
for var in ['sta','end']:
  tm=[i for i in inputs if var == i[:3]]
  for t in tm:
    inputs.update({t:int(inputs[t])})
  staend.update({var:datetime.datetime(inputs[tm[0]],inputs[tm[1]],inputs[tm[2]],inputs[tm[3]],)})
nt=int((staend['end']-staend['sta']).total_seconds()/3600./3)+1
fn_dt=[(staend['sta']+datetime.timedelta(hours=3*t)).strftime('%Y-%m-%d_%H:00:00') for t in range(nt)]
```
- CWBWRF基本上是一個wrfout檔案，因此其時間標籤是個變數，將其讀出成序列以利比對。

```python
fname='CWB_wrfout_d01'
wrfin = Dataset(fname,'r')
nt_cwb=wrfin.dimensions['Time'].size
strT=[''.join([i.decode('utf-8') for i in wrfin.variables['Times'][t,:]]) for t in range(nt_cwb)]
```
- 時間標籤匹配：`tcwb`為CWBWRF中的時間序位

```python
...
  if fn_dt[t] in strT:
    tcwb=strT.index(fn_dt[0])
  else:
    continue
```

### 氣象要素的讀取
- 使用wrf-python的getvar有其便利性，且不必再進行複雜的計算、單位轉換等過程，也可以避免錯誤的發生。
  - getvar項目內容可以參考[官網](https://wrf-python.readthedocs.io/en/latest/user_api/generated/wrf.getvar.html)，或[分類列表](https://sinotec2.github.io/FAQ/2022/08/11/wrf_pythonTAB.html)
- 地面物理量
  - uv10為U10及V10的合併
  - T2單位為K、tc單位為度C

```python
  p_met=getvar(metin, "pressure")
  uv10=getvar(wrfin,"uvmet10",timeidx=tcwb)
  t2=getvar(wrfin,"T2",timeidx=tcwb)
  for itm in ['ua','va','rh','tc']:
    cmd='cwb=getvar(wrfin, "'+itm+'",timeidx=tcwb)'
    exec(cmd)
```
### 高度內插
- 地面值：因每個項目的處理方式都不太一樣，只好以if...else來處理。
- 1~22層依序處理
  - 如果是CWBWRF的11層，直接移轉矩陣。不要再內插。內插反而會出錯(1000mb以下無值)。
  - 雖然[官網手冊][interplevel]說可以整批一起內插，但經T/E發現只能一層層進行。
- 回存時要注意metoa_em的風速UU(在x方向)及VV(在y方向)的維度會多1格，與getvar讀的結果不同，因此需限制其最大維度。  

```python
    var=np.zeros(shape=p_met.shape)
    if itm[1]=='a':
      var[0,:,:]=uv10[uvi[itm],:,:]
    elif itm=='tc':
      cwb+=273.
      var[0,:,:]=t2[:,:]
    else:
      var[0,:,:]=cwb[0,:,:]
    for k in range(1,22): #34-12):
      if k in kdic:
        var[k,:,:]=cwb[kdic[k],:,:]
      else:
        var[k,:,:]=interplevel(cwb,p,p_met[k,:,:])
    metin.variables[vdic[itm]][0,:22,:ny,:nx]=var[:22,:,:]
```
## [mk_metoa.py][mk_metoa]程式下載

{% include download.html content="將CWB數據填入WRF客觀分析場之程式：[mk_metoa.py](https://github.com/sinotec2/Focus-on-Air-Quality/blob/main/wind_models/OBSGRID/mk_metoa.py)" %}

## CWBWRF_15k vs 45k
- 15k版本裏新舊網格系統完全相同，只有高度時間的對應。
- 在45k版本，新網格是每3格採1次舊網格(CWBWRF_15k)數據，只要在水平xy平面上，以間格方式對照即可。

```python
31a32
> nz0,ny0,nx0=p.shape
41c42
<
---
> N=nx0//nx
60c61
<       var[0,:,:]=uv10[uvi[itm],:,:]
---
>       var[0,:,:]=uv10[uvi[itm],:-1:N,:-1:N]
63c64
<       var[0,:,:]=t2[:,:]
---
>       var[0,:,:]=t2[:-1:N,:-1:N]
65c66
<       var[0,:,:]=cwb[0,:,:]
---
>       var[0,:,:]=cwb[0,:-1:N,:-1:N]
68c69
<         var[k,:,:]=cwb[kdic[k],:,:]
---
>         var[k,:,:]=cwb[kdic[k],:-1:N,:-1:N]
70c71
<         var[k,:,:]=interplevel(cwb,p,p_met[k,:,:])
---
>         var[k,:,:]=interplevel(cwb[:,:-1:N,:-1:N],p[:,:-1:N,:-1:N],p_met[k,:,:])
```

## 東海台海版本
- 因為座標系統需要精準校對，此處改以scipy.griddata內插取代前述直接引用。
- CWBWRF_3Km格點多、檔案龐大，在[get_M-A0064.cs](https://sinotec2.github.io/Focus-on-Air-Quality/wind_models/cwbWRF_3Km/fil_grb_nc/#自動轉檔排程)中已經處理成逐日檔(約8.1G)，不是所有預報時間都在同一檔案內，需要一個目錄對照表，以讀取到正確的時間。

### CWBWRF_3Km網格定義
- 使用getvar取得wrfout的經緯度(為YX 2維矩陣)
- 使用pyproj.Proj模組轉到目標網格系統(metin)

```python
fname='CWB_wrfout_d03'
wrfin = Dataset(fname,'r')
p = getvar(wrfin, "pressure") #p is constant and homogeneous in x and y
latm,lonm=getvar(wrfin,'lat'),getvar(wrfin,'lon') #CWB net
...
pnyc = Proj(proj='lcc', datum='NAD83', lat_1=metin.TRUELAT1, lat_2=metin.TRUELAT2, lat_0=metin.CEN_LAT, lon_0=metin.CEN_LON, x_0=0, y_0=0)
x,y=pnyc(lonm,latm, inverse=False) #CWB net
```

### 目標網格系統
- 為要套用環保署公版模式的排放數據，需要將網格系統設計與其完全一致。依據其GRIDDESC內容如下：

```bash
$ cat /nas2/cmaq2019/download/input/201901/grid03/mcip/GRIDDESC
' '
'Taiwan'
  2        10.000        40.000       120.000       120.000        25.000
' '
'Taiwan'
'Taiwan'    -72000.000   -345000.000      3000.000      3000.000  92 131   1
' '
```
- 其中心位置(25,120)位在台海偏北方向，並非以臺灣為中心。
  - 之所以會以此為模擬中心，應為風場有更大範圍之需求。
  - 此處因主要援引中央氣象局的數值預報，做為4階同化的依據，並不重新進行動力模式模擬。範圍較小一些，可以取得mcip所需wrfout項目即可。
- 如要含概原點範圍，至少需有(200 &times; 300)點，範圍如圖所示。

| ![donghai_taihai.PNG](https://github.com/sinotec2/Focus-on-Air-Quality/raw/main/assets/images/donghai_taihai.PNG) |
|:--:|
| <b>東海台海模擬範圍</b>|  

```python
fname='met_em.d01.'+fn_dt[0]+'.nc'
metin = Dataset(fname,'r')
nz,ny,nx=p_met.shape

x1d=[metin.DX*i for i in range(-nx//2,nx//2)]
y1d=[metin.DY*i for i in range(-ny//2,ny//2)]
x1,y1=np.meshgrid(x1d, y1d)
maxx,maxy=x1[-1,-1],y1[-1,-1]
minx,miny=x1[0,0],y1[0,0]
boo=(abs(x) <= (maxx - minx) /2+metin.DX*10) & (abs(y) <= (maxy - miny) /2+metin.DY*10)
idx = np.where(boo)
mp=len(idx[0])
xyc= [(x[idx[0][i],idx[1][i]],y[idx[0][i],idx[1][i]]) for i in range(mp)]
```

### griddata內插副程式
- 因為需要內插的2維變數太多樣了，寫成簡單的副程式會比較方便

```python
def interpXY(arr):
  c = [arr[idx[0][i], idx[1][i]] for i in range(mp)]
  return griddata(xyc, c, (x1, y1), method='linear')
```
- 內插後存到var矩陣內，再一併回存到metin。
- 地面風速(uv10)、地面溫度(t2)、相同定壓層變數、需垂直內插之變數(先執行垂直內插)等，都呼叫interpXY

```python
  for itm in ['ua','va','rh','tc']:
    cmd='cwb=getvar(wrfin, "'+itm+'",timeidx=tcwb)'
    exec(cmd)
    var=np.zeros(shape=(nz,ny,nx))
    if itm[1]=='a':
      var[0,:,:]=interpXY(uv10[uvi[itm],:,:])
    elif itm=='tc':
      cwb+=273.
      var[0,:,:]=interpXY(t2[:,:])
    else:
      var[0,:,:]=interpXY(cwb[0,:,:])
    for k in range(1,22): #34-12):
      if k in kdic:
        var[k,:,:]=interpXY(cwb[kdic[k],:,:])
      else:
        var[k,:,:]=interpXY(interplevel(cwb[:,:,:],p[:,:,:],p_met[k,0,0]))
    metin.variables[vdic[itm]][0,:22,:ny,:nx]=var[:22,:,:]
```

### 時間標籤與CWBWRF檔案目錄的對照
- fn_dt為檔名中的時間標籤，與前述版本都一樣，沒有更動。逐3小時一筆
- fn_dt對照到WRF_3Km下存檔目錄(日期)，關係如下所示

```python
...
fn_dt=[(staend['sta']+datetime.timedelta(hours=3*t)).strftime('%Y-%m-%d_%H:00:00') for t in range(nt)]
#path dic of CWB_wrfouts, searched by fn_dt
dates={fn_dt[t]:(staend['sta']+datetime.timedelta(hours=t*3-6)).strftime('%Y%m%d') for t in range(nt)}
...
```
- WRF_3Km自06Z開始存檔，因此時間需扣6小時
- 日期格式為YYYYMMDD，即'%Y%m%d'
- 對照表應用在時間的迴圈內，因為是唯讀檔，不需特別予以關閉。strT也是隨著檔案開啟後再產生，以找到正確的序位(tcwb，用法與前述版本都一樣)。

```python
for t in range(nt):
  fname='met_em.d01.'+fn_dt[t]+'.nc'
  fnameO=fname.replace('met','metoa')
  os.system('cp '+fname+' '+fnameO)
  # only if fn_dt in strT(time overlaped)
  fname='/nas1/Data/cwb/WRF_3Km/'+dates[fn_dt[t]]+'/wrfout_d03_:00:00'
  wrfin = Dataset(fname,'r')
  nt_cwb=wrfin.dimensions['Time'].size
  strT=[''.join([i.decode('utf-8') for i in wrfin.variables['Times'][t,:]]) for t in range(nt_cwb)]
  if fn_dt[t] in strT:
    tcwb=strT.index(fn_dt[t])
  else:
    continue
```

### 平行計算版本
- 因griddata計算需時較久(處理一個metoa檔約需20分鐘)，如循序處理，會需要近19小時，因此必須同步處理不同時間的metoa檔。
- 設計將序號當成引數，前述時間迴圈只進行該小時之內插。

```python
$ diff mk_metoa45.py mk_metoaT.py
0a1
> #argument with time t=0~nt-1
5c6
< import os
---
> import os, sys
63c64,66
< for t in range(nt):
---
> tin=int(sys.argv[1])
> if tin>=nt:sys.exit('wrong T')
> for t in range(tin,tin+1):
```
- 因同時進行開啟、複製檔案，會造成記憶體嚴重耗盡，讓每批次工作之間相隔10秒鐘：

```bash
for i in {0..56};do sub python mk_metoaT.py $i;sleep 10s;done
```


| ![strline_wrf.png](https://github.com/sinotec2/Focus-on-Air-Quality/raw/main/assets/images/strline_wrf.png) |
|:--:|
| <b>東海台海模擬範圍之地面風氣流線與風速</b>|  


[mk_metoa]: <https://github.com/sinotec2/Focus-on-Air-Quality/blob/main/wind_models/OBSGRID/mk_metoa.py> "github.com/sinotec2/Focus-on-Air-Quality/wind_models/OBSGRID/mk_metoa.py"
[interplevel]: <https://wrf-python.readthedocs.io/en/latest/user_api/generated/wrf.interplevel.html?highlight=interplevel> "Return the three-dimensional field interpolated to a horizontal plane at the specified vertical level."







