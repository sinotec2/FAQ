---
title: 預報系統圖檔之拮取
tags: forecast bash m3nc2gif NCO
layout: article
aside:
  toc: true
sidebar:
  nav: layouts
date:  2022-10-20
modify_date: 2022-10-20 16:41:13
---

## 背景
- [地區空品預報系統][fcst]擁有多污染物、多時間、多解析度的龐雜檔案系統，因此當在[Earth]()展示畫面發現有特殊的污染事件，要從中拮取高清畫面，似乎不是那麼友善。需要一個快捷的工具。
- 此處以類似拮取環保署數據的[specHrSliderRect.py]()輸入方式，給定起迄時間(YYYMMDDHH格式)、污染物名稱、以及模擬網格編號，即可使用[m3nc2gif][m3nc2gif]程式，將CMAQ結果轉成gif檔案。

## 程式腳本IO
### 命令列引數
使用範例：`$fcst/aconc2gif.cs 2022102209 2022102409 PM10 1`
1. 開始日期時間：UTC、YYYMMDDHH格式
1. 結束日期時間：UTC、YYYMMDDHH格式，可與前述開始時間相同，但不能較早
1. 污染項目：目前以PMs、VOC等為選擇
1. 模擬網格編號：1~3

### 輸入檔案
- 指定目錄必須存在PMs處理結果

### 輸出gif檔案
- 會存在`root=${fcst}/${GRD[$d]}/cctm.fcst/daily`目錄下
- 檔名為`${s}_${b}.gif`，如PM10_2022102409.gif

### 呼叫程式
- ~/bin/c2j：即為cal2jul.f，轉換成julian day以便進行計算
- NCO程式：ncks及ncrcat，進行模擬結果檔案的切割與連接。
- ~/bin/[m3nc2gif.py][m3nc2gif]：進行製圖與convert。

## 程式設計
### 日期的轉換
- 用`cut`指令將輸入的起(`b`)迄(`e`)時間抽出日期及時間
- 日期轉換成julian day(`~/bin/c2j`)、小時數也轉換成10進位之整數(`#10`)

```bash
bd=$(echo $b|cut -c 3-8)
bj=$(~/bin/c2j $bd)
bh=$(echo $b|cut -c 9-10)
bh=$(( 10#$bh ))

ed=$(echo $e|cut -c 3-8)
ej=$(~/bin/c2j $ed)
eh=$(echo $e|cut -c 9-10)
eh=$(( 10#$eh ))
```

- 每天的起迄小時：切割時需要精確到逐時
  - 如果是端點日期，需要改成起迄時
  - 如果不是，則為0~23

```bash
  jbh=0; test 20$bd == ${dates[$jd1]} && jbh=$(( $bh - 1))
  jeh=23; test 20$ed == ${dates[$jd1]} && jeh=$(( $eh - 1 ))
```

### 可變動的迴圈範圍
- bash不接受可變動的迴圈(`for i in {${bj}..${ej});`)，主要因為用了2次{}。
- bash可以接受`for i in $(seq $bj $ej);do`的寫法。$()只有執行一次，還算單純。
- 本腳本一共用了4次

```bash
...
dates=();for i in $(seq $bj $ej);do dates=( ${dates[@]} $(~/bin/j2c $i) );done
...
for jd in $(seq 1 $nd);do
...
  for jh in $(seq $jbh $jeh);do
...
rm ${s}_*.png;for i in $( seq 0 $len);do rm ${fnames[$i]};done
```

### 可變動的序列內容
- bash的序列可以是固定長度內容，明確寫在程式內，也可以在程式內逐一增加擴充。本腳本一共用了5個序列，3個是固定，2個是浮動(每次執行臨時產生)。
- 產生所有日期之序列：
  - 因應檔案的命名系統都是使用日期，
  - 因此需要起、迄之間每一天的日期序列、與序列長度

```bash
dates=();for i in $(seq $bj $ej);do dates=( ${dates[@]} $(~/bin/j2c $i) );done
nd=${#dates[@]}
```
- `ncrcat`需要的引數
  - 過去`ncrcat`會以符合條件的所有檔(通配符 wild card `*`)來指定需連結的檔案，不但不明確也容易出錯。以序列定義絕對不會出錯。
  - 切割產生的結果檔，需全部、依序排列進行`ncrcat`將其連結成新的檔案，此時的結果檔名也以序列將其儲存、
  - 序列內容再以`echo`及`eval`傳到`ncrcat`程式內，避免使用通配符。

```bash
fnames=()
for jd in $(seq 1 $nd);do
...
  for jh in $(seq $jbh $jeh);do
    fnameo=${root}/${s}${dates[$jd1]}_$jh
    $NCKS -O -v TFLAG,$s -d TSTEP,$jh $fname $fnameo
    fnames=( ${fnames[@]} $fnameo )
  done
done
a='$NCRCAT -O '$(echo ${fnames[@]})' $s.nc'
eval $a
```

## 腳本內容

```bash
kuang@master /nas2/cmaqruns/2022fcst
$ cat aconc2gif.cs
NCKS=/usr/bin/ncks
NCRCAT=/usr/bin/ncrcat
fcst=/nas2/cmaqruns/2022fcst
b=$1 #begin YYYYMMDDHH
e=$2 #end YYYYMMDDHH
s=$3 #species name
d=$4 #domain 1~3
PM_s=( "PM10" "PM1_TOT" "PM25_TOT" "PMC_TOT" "VOC" )
GRD=( 'grid45'  'grid09'  'grid03' )
DOM=( 'CWBWRF_45k' 'SECN_9k' 'TWEPA_3k')


bd=$(echo $b|cut -c 3-8)
bj=$(~/bin/c2j $bd)
bh=$(echo $b|cut -c 9-10)
bh=$(( 10#$bh ))

ed=$(echo $e|cut -c 3-8)
ej=$(~/bin/c2j $ed)
eh=$(echo $e|cut -c 9-10)
eh=$(( 10#$eh ))

dates=();for i in $(seq $bj $ej);do dates=( ${dates[@]} $(~/bin/j2c $i) );done
nd=${#dates[@]}

len=$(( ( $ej - $bj ) * 24 + $eh - $bh ))

js=-1
for i in {0..4};do
  if [ $s == ${PM_s[$i]} ];then
    js=$i
  fi
done
d=$(( $d - 1 ))
if [ $js -ge 0 ];then
  FN=PMs
else
  FN=CCTM_ACONC_v532_intel_${DOM[$d]}_
fi

root=${fcst}/${GRD[$d]}/cctm.fcst/daily
fnames=()
for jd in $(seq 1 $nd);do
  jd1=$(( $jd - 1))
  fname=${root}/PMs${dates[$jd1]}.nc
  jbh=0; test 20$bd == ${dates[$jd1]} && jbh=$(( $bh - 1))
  jeh=23; test 20$ed == ${dates[$jd1]} && jeh=$(( $eh - 1 ))
  echo $file $jbh $jeh
  for jh in $(seq $jbh $jeh);do
    fnameo=${root}/${s}${dates[$jd1]}_$jh
    $NCKS -O -v TFLAG,$s -d TSTEP,$jh $fname $fnameo
    fnames=( ${fnames[@]} $fnameo )
  done
done
pwd=$PWD
cd $root
a='$NCRCAT -O '$(echo ${fnames[@]})' $s.nc'
eval $a
rm ${s}_*.png;for i in $( seq 0 $len);do rm ${fnames[$i]};done
~/bin/m3nc2gif.py $s.nc
mv $s.gif ${s}_${b}.gif
cd $pwd
```

[fcst]: <https://sinotec2.github.io/Focus-on-Air-Quality/GridModels/ForecastSystem/> "逐日WRF與CMAQ預報系統之建置"
[m3nc2gif]: <https://sinotec2.github.io/Focus-on-Air-Quality/utilities/Graphics/wrf-python/4.m3nc2gif/> "m3nc檔案轉GIF"