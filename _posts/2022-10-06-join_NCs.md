---
title: 跨批次濃度檔之串連與均勻化
tags: CMAQ combine
layout: article
aside:
  toc: true
sidebar:
  nav: layouts
date:  2022-10-05
modify_date: 2022-10-05 16:53:27
---
## 背景
- 將CCTM_ACONC或者是combine結果檔，按照時間軸以ncrcat串連後，因在換日時更換了起始濃度與執行批次，致使等濃度結果(gif檔)產生跳動情形。
- 這一題類似[intp_json][intp_json]，差異在作用在nc檔案還是json檔案、以及漸變的時間周期。nc檔是為做m3nc2gif.py，json檔則是為earth顯示系統。
- 跨批次的nc檔案，會在全域屬性中的CDATE及CTIME(current date/time)性質中顯示，
  - 同一執行批次檔案CDATE/CTIME時間會彼此相近，後產生的檔案略大於前者，因此串連並無問題。
  - 不同批次結果之間的CDATE/CTIME時間會有較大的差距。因此以datetime進行時間差異的計算，即可予以辨識並進行修正。

## 程式設計
### IO
- 引數：具時間順序之nc檔、以及結果檔名
- 各濃度檔

### 是否同一批次的辨識
- 時間差在1小時之內，為同一執行批次的結果。`0<=delt<3600.`

### 時間軸之漸變
- 周期：`nt=24`
- 加權：
  - 線性
  - `var0[:,t,:,:,:]=var[:,t0+t,:,:,:]*(nt-t)/nt +  var[:,t1,:,:,:]*t/nt`

### 程式碼
```python
#kuang@DEVP /nas2/cmaqruns/2022fcst/grid45/cctm.fcst/daily
#$ cat join_NCs.py
#!/cluster/miniconda/envs/unresp/bin/python
import os, sys
import netCDF4
import numpy as np
from dtconvertor import dt2jul, jul2dt

nf=len(sys.argv)-1
fnames=[sys.argv[i+1] for i in range(nf)]
cdates, tflags=[],[]
for n in range(nf-1):
  nc = netCDF4.Dataset(fnames[n],'r')
  t0,t1=n*24,(n+1)*24
  if n==0: #first time declarations
    V=[list(filter(lambda x:nc.variables[x].ndim==j, [i for i in nc.variables])) for j in [1,2,3,4]]
    nt,nlay,nrow,ncol=nc.variables[V[3][0]].shape
    nv=len(V[3])
    var=np.zeros(shape=(nv,(nf-1)*24,nlay,nrow,ncol))
  for iv in range(nv): #store the variables and current time/flags of files
    var[iv,t0:t1,:,:,:]=nc.variables[V[3][iv]][:,:,:,:]
  cdates.append(jul2dt([nc.CDATE,nc.CTIME]))
  tflags.append([jul2dt(nc['TFLAG'][t,0,:]) for t in range(24)])
nt=24 #time interplation period, in hours
for n in range(nf-2):
  delt=(cdates[n+1]-cdates[n]).total_seconds()
  if 0<=delt<3600.:continue # if conc are from same batch, skip interpolation
  t0,t1=(n+1)*24-nt,(n+1)*24
  var0=np.zeros(shape=(nv,nt,nlay,nrow,ncol))
  for t in range(nt): # transition in nt hours
    var0[:,t,:,:,:]=var[:,t0+t,:,:,:]*(nt-t)/nt +  var[:,t1,:,:,:]*t/nt
  var[:,t0:t1,:,:,:]=var0[:,:,:,:,:]

os.system('cp '+fnames[-2]+' '+fnames[-1])
nc = netCDF4.Dataset(fnames[-1],'r+')
#expand the nc file
for n in range(nf-1):
  t0,t1=n*24,(n+1)*24
  for t in range(t0,t1):
    nc.variables['TFLAG'][t,0,:]=dt2jul(tflags[n][t-t0])
var0=np.zeros(shape=nc.variables['TFLAG'].shape)
var0[:,:,:]=np.array(nc.variables['TFLAG'][:,0,:])[:,None,:]
nc.variables['TFLAG'][:,:,:]=var0[:,:,:]

for iv in range(nv):
  nc.variables[V[3][iv]][:,:,:,:]=var[iv,:,:,:,:]
nc.close()
```

[intp_json]: <https://sinotec2.github.io/FAQ/2022/10/04/intp_json.html> "時間內插取代初始小時濃度"