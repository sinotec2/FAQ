---
title: CAMx模擬結果之壓縮
tags: CAMx fortran uamiv ncks
layout: article
aside:
  toc: true
sidebar:
  nav: layouts
date:  2022-07-19 
modify_date: 2022-07-19 14:42:30
---
## 背景
- 此程式系列之目的在於整併CAMx的模擬結果，產生測站量測之空品項目，以利後續分析及比對。整併項目包括：
  - NMHC：濃度乘上碳數之sumproduct
  - PM：PM<sub>2.5</sub>及PM<sub>10</sub>
- 除了fortran程式之外，同樣功能也可以在python中實現



## [shkavgcb6.f90](https://github.com/sinotec2/Focus-on-Air-Quality/blob/main/CAMx/PostProcess/shkavgcb6.f90)程式設計

## shkavg4.4.f90
- 這個版本的VOC's項目(nvlst)較少，只有36項，適用較早期的cb5反應機制。
- 輸出項目也少1項CO。這是因為早期反應機制中沒有輸出這個項目。

```bash
$ diff shkavg4.4.f90 shkavgcb6.f90
9,10c9,10
<    integer,parameter::nlst=32,nvlst=36  
<    integer,parameter::nout=8  
---
>    integer,parameter::nlst=32,nvlst=62 
>    integer,parameter::nout=9  
```
## shkavgPar.f90
- 這個最早版本與shkavg4.4.f90的差異在於部分VOC's的名稱在反應機制中略有改變。
- 影響所及也包括個別物質的碳數

```bash
diff shkavg4.4.f90 shkavgPar.f90
130,131c131,132
<    lsvname(17)  = 'ISPD'
<    lsvname(18)  = 'ISPX' !
---
>    lsvname(17)  = 'ISP'  !ISP = ISOP
>    lsvname(18)  = 'ISPD' !
145c146
<    lsvname(32)  = 'TO2' !TO2 =  Peroxy radical from OH addition to TOL 7 173.1
>    lsvname(32)  = 'TOLA' !TOLA = TOL or ARO1
149c150
<    lsvname(36)  = 'XLO2' !Peroxy radical from OH addition to XYL 8 187.1
---
>    lsvname(36)  = 'XYLA' !XYLA = XYL or ARO2
```

## [shk3.py](https://github.com/sinotec2/Focus-on-Air-Quality/blob/main/CAMx/PostProcess/shk3.py)
- 這支程式會讀取測站上的測值來修正CAMx的瞬間檔，做為以觀測濃度重啟模式之用。

### 程式IO
- 引數：年月日時(YYMMDDHH共8碼)
- 粒狀物名稱：從`'/nas1/camxruns/2013_enKF/inputs/part.txt'`中讀取
  - 此檔案由反應機制文字檔中拮取
- 測站觀測值(同一網格測站取平均值)：`'/home/backup/data/epa/pys/2013ByMonth/'+YMDH[:4]+'IJ4.csv'`
- CAMx模擬結果瞬時檔(YYMMDDHH.finst)
  - 會複製成輸出檔(YYMMDDHH **R**.finst)
  - 檔案格式：[uamiv][uamiv]

### 分配邏輯
- 氣狀物`['CO', 'NO2',  'O3', 'SO2']`
  - 測站網格所在位置的濃度，直接換成測站(平均)值
- NMHC
  - 先計算模擬之NMHC(ppbc)
  - 按照個別物種所佔ppbc比例整比分配觀測值
  - 除回碳數成為ppm濃度
- 粒狀物  
  - 每個成分的PM<sub>2.5</sub>部分有其比例。乘上比例加總成PM<sub>2.5</sub>模擬值，修正值為觀測值按模擬值正比分配。
  - PM<sub>10</sub>為所有粒狀物的總合。計算粗粒部分之觀測與模擬值。將粗粒分配給`'CPRM CCRS PH2O'.split()`這3項

## shk_camx.cs
- 這個版本以[pncgen][pncgen]進行變數之提取(沒有加總)
- 如果是nc格式，則以[ncks][ncks]進行提取，選項略有差異

```bash
kuang@master ~/bin
$ cat shk_camx.cs
if [ $HOSTNAME == '114-32-164-198.HINET-IP.hinet.net' ];then NCO='/opt/anaconda3/bin'
elif [ $HOSTNAME == 'master' ];then NCO='/cluster/netcdf/bin'
elif [ $HOSTNAME == 'node01' ];then NCO='/cluster/netcdf/bin'
elif [ $HOSTNAME == 'centos8' ];then NCO='/opt/anaconda3/envs/py37/bin'
elif [ $HOSTNAME == 'node03' ];then NCO='/opt/miniconda3/bin'
else NCO='/usr/bin'
fi
NCKS='pncgen -f uamiv'
NCRCAT=${NCO}/ncrcat

VAR='TFLAG,CO,NO2,SO2,O3,PAR,PSO4,PNO3,PNH4,FPRM,FCRS'

$NCKS -O --slice LAY,0,0 -v $VAR $1 $2
#$NCKS -O -v $VAR -d LAY,0,0 $1 $2
```

## shk.cs
- 原則同上，程式自行判斷是CMAQ或者是CAMx產出之結果。

```bash
kuang@master ~/bin
$ cat shk.cs
nc=$1
if [ $HOSTNAME == '114-32-164-198.HINET-IP.hinet.net' ];then NCO='/opt/anaconda3/bin'
elif [ $HOSTNAME == 'master' ];then NCO='/cluster/netcdf/bin'
elif [ $HOSTNAME == 'node01' ];then NCO='/cluster/netcdf/bin'
elif [ $HOSTNAME == 'node02' ];then NCO='/cluster/netcdf/bin'
elif [ $HOSTNAME == 'centos8' ];then NCO='/opt/anaconda3/envs/py37/bin'
elif [ $HOSTNAME == 'node03' ];then NCO='/opt/miniconda3/bin'
else NCO='/usr/bin'
fi
NCKS=${NCO}/ncks
NCRCAT=${NCO}/ncrcat
NCDUMP=${NCO}/ncdump
v=$($NCDUMP -h $nc|grep PM25|wc -l)
a=$($NCDUMP -h $nc|grep AVERAGE|wc -l)
if [ $v != 0 ];then
  if  [ $a == 0 ];then
    #cmaq combined files
    VAR='TFLAG,CO,NO2,SO2,O3,PM25_NO3,PM25_SO4,PM25_TOT,PM10,VOC'
  else
  #version 700 nc directly from CAMx
    VAR='TFLAG,CO,NO2,SO2,O3,PNO3,PSO4,PNH4,PAR,CCRS,FCRS,CPRM,FPRM'
  fi
#camx>400, nc generated by pncgen from uamiv file
else
  VAR='TFLAG,CO,NO2,SO2,O3,PNO3,PSO4,PNH4,PAR,CCRS,FCRS,CPRM,FPRM'
fi
if ! [ -e $2 ];then
  touch $2
  res=${VAR//[^,]}
  nvars=$(echo ${#res})
  $NCKS -O -v $VAR -d LAY,0,0 -d VAR,1,$nvars $1 $2
  ncatted -a NVARS,global,o,i,$nvars $2
fi
```
- `$res`為`$VAR`中的所有逗號(從開使到逗號中的內容置換成null，`[...]`則會重覆執行)
- `${#res}`則為`$res`的長度

[uamiv]: <https://github.com/sinotec2/camxruns/wiki/CAMx(UAM)的檔案格式> "CAMx所有二進制 I / O文件的格式，乃是遵循早期UAM(城市空氣流域模型EPA，1990年）建立的慣例。 該二進制文件包含4筆不隨時間改變的表頭記錄，其後則為時間序列的數據記錄。詳見CAMx(UAM)的檔案格式"
[pncgen]: <https://sinotec2.github.io/Focus-on-Air-Quality/utilities/netCDF/pncgen/#pncgen> "FAQ -> Utilitie -> NetCDF Relatives -> ncgen & pncgen -> pncgen"
[ncks]: <https://sinotec2.github.io/Focus-on-Air-Quality/utilities/netCDF/ncks/> "NCKS 在空品模式中的應用"