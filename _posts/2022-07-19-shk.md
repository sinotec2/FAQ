---
title: CAMx模擬結果之壓縮
tags: CAMx fortran uamiv ncks
layout: article
aside:
  toc: true
sidebar:
  nav: layouts
date:  2022-07-19 
modify_date: 2022-07-19 14:42:30
---
## 背景
- 此程式系列之目的在於整併CAMx的模擬結果，產生測站量測之空品項目，以利後續分析及比對。整併項目包括：
  - NMHC：濃度乘上碳數之sumproduct
  - PM：PM2.5及PM10
- 除了fortran程式之外，同樣功能也可以在python中實現



## [shkavgcb6.f90](https://github.com/sinotec2/Focus-on-Air-Quality/blob/main/CAMx/PostProcess/shkavgcb6.f90)程式設計

## shkavg4.4.f90
- 這個版本的VOC's項目(nvlst)較少，只有36項，適用較早期的cb5反應機制。
- 輸出項目也少1項CO。這是因為早期反應機制中沒有輸出這個項目。

```bash
$ diff shkavg4.4.f90 shkavgcb6.f90
9,10c9,10
<    integer,parameter::nlst=32,nvlst=36  
<    integer,parameter::nout=8  
---
>    integer,parameter::nlst=32,nvlst=62 
>    integer,parameter::nout=9  
```
## shkavgPar.f90
- 這個最早版本與shkavg4.4.f90的差異在於部分VOC's的名稱在反應機制中略有改變。
- 影響所及也包括個別物質的碳數

```bash
diff shkavg4.4.f90 shkavgPar.f90
130,131c131,132
<    lsvname(17)  = 'ISPD'
<    lsvname(18)  = 'ISPX' !
---
>    lsvname(17)  = 'ISP'  !ISP = ISOP
>    lsvname(18)  = 'ISPD' !
145c146
<    lsvname(32)  = 'TO2' !TO2 =  Peroxy radical from OH addition to TOL 7 173.1
>    lsvname(32)  = 'TOLA' !TOLA = TOL or ARO1
149c150
<    lsvname(36)  = 'XLO2' !Peroxy radical from OH addition to XYL 8 187.1
---
>    lsvname(36)  = 'XYLA' !XYLA = XYL or ARO2
```

## [shk3.py](https://github.com/sinotec2/Focus-on-Air-Quality/blob/main/CAMx/PostProcess/shk3.py)
- 這支程式會讀取測站上的測值來修正CAMx的瞬間檔，做為以觀測濃度重啟模式之用。

### 程式IO
- 引數：年月日時(YYMMDDHH共8碼)
- 粒狀物名稱：從`'/nas1/camxruns/2013_enKF/inputs/part.txt'`中讀取
  - 此檔案由反應機制文字檔中拮取
- 測站觀測值(同一網格測站取平均值)：`'/home/backup/data/epa/pys/2013ByMonth/'+YMDH[:4]+'IJ4.csv'`
- CAMx模擬結果瞬時檔(YYMMDDHH.finst)
  - 會複製成輸出檔(YYMMDDHH **R**.finst)
  - 檔案格式：[uamiv][uamiv]

### 分配邏輯
- 氣狀物`['CO', 'NO2',  'O3', 'SO2']`
  - 測站網格所在位置的濃度，直接換成測站(平均)值
- NMHC
  - 先計算模擬之NMHC(ppbc)
  - 按照個別物種所佔ppbc比例整比分配觀測值
  - 除回碳數成為ppm濃度
- 粒狀物  
  - 每個成分的PM2.5部分有其比例。乘上比例加總成PM2.5模擬值，修正值為觀測值按模擬值正比分配。
  - PM10為所有粒狀物的總合。計算粗粒部分之觀測與模擬值。將粗粒分配給`'CPRM CCRS PH2O'.split()`這3項


[uamiv]: <https://github.com/sinotec2/camxruns/wiki/CAMx(UAM)的檔案格式> "CAMx所有二進制 I / O文件的格式，乃是遵循早期UAM(城市空氣流域模型EPA，1990年）建立的慣例。 該二進制文件包含4筆不隨時間改變的表頭記錄，其後則為時間序列的數據記錄。詳見CAMx(UAM)的檔案格式"