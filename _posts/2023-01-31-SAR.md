---
layout: article
title: Spatial Autocorrelation
parent: Recommend System
grand_parent: CMAQ Model System
nav_order: 99
date: 2023-01-23
last_modified_date: 2023-01-23 09:30:02
tags: SAR
mermaid: true
aside:
  toc: true
sidebar:
  nav: layouts
---

## 背景

- [Exploratory Analysis of Spatial Data: Spatial Autocorrelation](https://pysal.org/esda/notebooks/spatialautocorrelation.html)
- [geopandas install not well](https://github.com/geopandas/geopandas/issues/556)
- [Geopandas cannot be installed on M1 #1816 ](https://github.com/geopandas/geopandas/issues/1816)
  - 

    I was having trouble running the above steps. What worked for me was to brew install gdal proj and then run
    pip install geopandas
    Hope this may help someone later on.

    This worked for me, too! Thanks 😘

- [Spatial Autocorrelation (Global Moran's I) (Spatial Statistics)](https://pro.arcgis.com/en/pro-app/2.9/tool-reference/spatial-statistics/spatial-autocorrelation.htm)
- [Spatial Statistics toolbox of ARCGIS](https://pro.arcgis.com/en/pro-app/latest/tool-reference/spatial-statistics/an-overview-of-the-spatial-statistics-toolbox.htm)
- [Senior Research Engineer at Simula Research Laboratory.](https://github.com/annefou)
  - [Working with Spatio-temporal data in Python](https://annefou.github.io/metos_python/)
- [Spatiotemporal machine learning in Python (Part 1)](https://av.tib.eu/media/55234)
- [Spatial Regression](https://geographicdata.science/book/notebooks/11_regression.html)
- [STPredict package](https://pypi.org/project/stpredict/)
  - STPredict is designed to apply forecasting methods on spatio-temporal data in order to predict the values of a target variable in the future time points based on the historical values of the features. The main stages of the modeling process are implemented in this package, including:
    - Data preprocessing
    - Data partitioning
    - Feature selection
    - Model selection
    - Model evaluation
    - Prediction
- [ spatial regression graph convolutional neural networks (SRGCNN) and its Geographically Weighted variant (SRGCNN-GW)](https://github.com/dizhu-gis/SRGCNN/blob/main/SRGCNN_demo.ipynb)

## SPATIO-TEMPORAL MODELS

### Special Issue "Spatio-Temporal Analysis of Air Pollution"

- mdpi special_issues: [source](https://www.mdpi.com/journal/atmosphere/special_issues/spatio_temporal_air_pollution)
- [DEB AND TSAY(2019)](https://www3.stat.sinica.edu.tw/statistica/oldpdf/A29n35.pdf)
  - Soudeep Deb and Ruey S. Tsay(2019) SPATIO-TEMPORAL MODELS WITH SPACE-TIME INTERACTION AND THEIR APPLICATIONS TO AIR POLLUTION DATA, Statistica Sinica 29 (2019), 1181-1207

- [Combined Aqua & Terra Product: MCD19A2N](https://modaps.modaps.eosdis.nasa.gov/services/about/products/c6-nrt/MCD19A2N.html)
  - Wang, P.; Tang, Q.; Zhu, Y.; Zheng, K.; Liang, T.; Yu, Q.; He, Y.(2022) Validation and Analysis of MAIAC AOD Aerosol Products in East Asia from 2011 to 2020, Remote Sens. 2022, 14, 5735. https://doi.org/10.3390/rs14225735
  - [worldview.earthdata.nasa.gov](https://worldview.earthdata.nasa.gov/?v=75.41329073293065,9.898161221122777,148.05286987514,41.3469373471444&l=Reference_Labels_15m(hidden),Reference_Features_15m(hidden),Coastlines_15m,MODIS_Combined_MAIAC_L2G_AerosolOpticalDepth,VIIRS_NOAA20_CorrectedReflectance_TrueColor(hidden),VIIRS_SNPP_CorrectedReflectance_TrueColor(hidden),MODIS_Aqua_CorrectedReflectance_TrueColor(hidden),MODIS_Terra_CorrectedReflectance_TrueColor(hidden)&lg=true&s=121.5636,25.0374&t=2023-01-07-T06%3A00%3A00Z)
  - get data(UN=gmail,PW=Iyck+emp#)，see [guidance](https://urs.earthdata.nasa.gov/documentation/for_users/data_access/curl_and_wget)

```bash
target=https://e4ftl01.cr.usgs.gov/MOTA/MCD19A2.006/2023.01.22/MCD19A2.A2023022.h35v09.006.2023024061517.hdf
echo "machine urs.earthdata.nasa.gov login some_user password ABCdef123!" > ~/.netrc
wget --load-cookies ~/.urs_cookies --save-cookies ~/.urs_cookies --keep-session-cookies $target
```
- hdf dump -> [eos2dump](https://www.hdfeos.org/software/eosdump.php)
- [Sinusoidal Tile Grid](https://modis-land.gsfc.nasa.gov/MODLAND_grid.html)
 
![Sinusoidal Tile Grid](https://modis-land.gsfc.nasa.gov/images/MODIS_sinusoidal_grid1.gif)
  - h28~29
  - v6

h|minLon|maxLon|meanLon
-|-|-|-
28|106.42502852043123|127.00691576585233|116.71597214314178
29|117.06708795332463|138.5534363855025|127.81026216941356

v|minLat|maxLat|meanLat
-|-|-|-
6|20.004166664867235|29.995833330639616|24.999999997753427

- get scripts(gg.cs)

```bash
bdate=20190101
for i in {4..364};do
  wdate=`date -d "$bdate +${i}days" +%Y.%m.%d`
  url=https://e4ftl01.cr.usgs.gov/MOTA/MCD19A2.006/$wdate
  wget -q $url
  for h in 28 29;do
    hdf=`grep hdf $wdate |grep -v xml|cut -d'"' -f 6|grep h${h}v06`
    wget -q --load-cookies ~/.urs_cookies --save-cookies ~/.urs_cookies --keep-session-cookies ${url}/$hdf
  done
done
if ! [ -e h4tonccf_nc4 ];then 
  wget -q https://www.hdfeos.org/software/h4cflib/bin/linux/v1.3/CentOS6/h4tonccf_nc4
fi
for hdf in $(ls *.hdf);do 
  nc=${hdf/hdf/nc}
  h4tonccf_nc4 $hdf $nc >&/dev/null
done
```

### Earth Observation Using Python

Earth Observation Using Python Rebekah B. Esmaili, [Earth Observation Using Python](https://www.academia.edu/59873812/Earth_Observation_Using_Python)

- A New Practical Guide to Using Python for Earth Observation
- [By R. B. Esmaili, 6 August 2021](https://eos.org/editors-vox/a-new-practical-guide-to-using-python-for-earth-observation)

### HDF-EOS TOOLS AND INFORMATION CENTER

@https://www.hdfeos.org/
[HDF4 CF CONVERSION TOOLKIT](https://www.hdfeos.org/software/h4cflib.php)

### nanmean for large matrix

```python
data = np.array([[1,2,3], [4,5,np.NaN], [np.NaN,6,np.NaN], [0,0,0]])
masked_data = np.ma.masked_array(data, np.isnan(data))
# calculate your weighted average here instead
weights = [1, 1, 1]
average = np.ma.average(masked_data, axis=1, weights=weights)
# this gives you the result
result = average.filled(np.nan)
print(result)
```

APPLICATIONS

- generate the filenames txt file:`2019allnc.txt`

`ls MCD19A2.A2019*.h28*.nc >2019allnc.txt`

```python
with open('2019allnc.txt','r') as f:
    fnames=[i.strip('\n') for i in f]
var0=np.ones(shape=(365,4,1200,1200))*-1
i=0
for fname in fnames:
  nc = netCDF4.Dataset(fname,'r')
  nlay=nc[v].shape[0]
  var0[i,:nlay,:,:]=np.array(nc[v][:,:,:])
  i+=1
varn=np.where(var0>=0,var0, np.nan)
varm = np.ma.masked_array(varn, np.isnan(varn))
weights = np.ones(shape=365)
average = np.ma.average(varm, axis=0, weights=weights)
var=average.filled(np.nan)
fname='2019T.nc'
nc = netCDF4.Dataset(fname,'r+')
# each orbit

nc[v][0,:,:,:]=np.flip(var[:,:,:],axis=1)
# orbits average
nc[v][0,0,:,:]=np.mean(np.flip(var[:,:,:],axis=1),axis=0)
```

![]()

### Handschuh et.al(2022)Estimating PM2.5 Surface Concentrations from AOD

Handschuh, Jana, Thilo Erbertseder, Martijn Schaap及Frank Baier. 「Estimating PM2.5 Surface Concentrations from AOD: A Combination of SLSTR and MODIS」. Remote Sensing Applications: Society and Environment 26 (2022年4月1日): 100716. https://doi.org/10.1016/j.rsase.2022.100716.

> Compared to surface in-situ observations, satellite data on aerosol optical depth (AOD) enables area-wide monitoring of tropospheric aerosols. However, coverage and reliability of satellite data products depend on atmospheric conditions and surface concentrations have to be retrieved from AOD. 
> This study investigates the potential to produce reliable maps of PM2.5 surface concentrations for Germany and parts of the surrounding countries using AOD based on observations by three different satellite sensors. 
> For the first time, AOD retrievals from the Sea and Land Surface Temperature Radiometer (SLSTR) onboard Sentinel-3A are used together with those from the Moderate Resolution Imaging Spectroradiometer (MODIS) onboard the two NASA platforms Terra and Aqua. 
> We investigate the differences and similarities of the three different satellite products in terms of coverage, resolution and algorithmic performances. 
> Based on this analysis we examine the suitability and advantage of a combination of these data sets. We can substantiate an increase in mean daily coverage from a maximum of 10.2% for the individual products to 16.7% for the ensemble product.
> Using a semi-empirical linear regression model, we derive surface-level PM2.5 concentrations and attain an overall correlation of 0.76 between satellite-derived and in-situ measured PM2.5 concentrations.
> By considering surface measurements, the systematic error (bias) and the root mean square error (RMSE) can be significantly reduced. 
> The general model performance is evaluated by a 5-fold cross validation and the relative prediction error (RPE).